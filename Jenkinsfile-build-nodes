library("tdr-jenkinslib")

pipeline {
  agent {
    label "master"
  }
  parameters {
    string(
      name: 'BRANCH',
      defaultValue: 'master',
      description: 'The branch to build from, defaults to master branch if not specified')
    choice(
      name: 'ECR_REPOSITORY',
      choices: ['sandbox', 'mgmt'],
      description: 'Sets the ECR repository to push to.'
    )
    choice(
      name: 'JENKINS_NODE',
      choices: ['aws', 'jenkins', 'jenkins-prod', 'npm', 'plugin-updates', 'postgres', 'terraform', 'transfer-frontend'],
      description: 'The Jenkins node you wish to build')
    }
    stages {
      stage('Build node') {
        steps {
          dir("./docker/nodes") {
            script {
              def account = params.ECR_REPOSITORY == "sandbox" ? "${env.SANDBOX_ACCOUNT}" : "${env.MANAGEMENT_ACCOUNT}"
              def imageName = params.JENKINS_NODE == "jenkins" || "jenkins-prod" ? "${params.JENKINS_NODE}" : "jenkins-build-${params.JENKINS_NODE}"
              def ecrRoot = "${account}.dkr.ecr.eu-west-2.amazonaws.com"
              def imageTag = params.ECR_REPOSITORY == "sandbox" ? "${ecrRoot}/sandbox_ecr_repository:${imageName}"
                      : "${ecrRoot}/${imageName}:latest"
              def dockerFileLocation = params.JENKINS_NODE == "jenkins" || "jenkins-prod" ? "." : "-f ${params.JENKINS_NODE}"

              sh "docker build ${dockerFileLocation}/Dockerfile --pull --no-cache -t ${imageTag} ."
              sh "aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin ${account}.dkr.ecr.eu-west-2.amazonaws.com"
              sh "docker push ${imageTag}"
            }
          }
        }
      }
    }
  }

