def versionTag = "v${env.BUILD_NUMBER}"
pipeline {
  agent {
    ecs {
      inheritFrom 'plugin-updates'
    }
  }

  stages {
    stage('Test') {
      steps {
        script {
          def branch = plugin-updates-${versionTag}
          checkout scm
          sh 'plugin-updates'
          sh 'git status'
          sh "git checkout -b ${branch}"
          sh 'git add  docker/plugins.txt'
          sh "git config --global user.email tna-digital-archiving-jenkins@nationalarchives.gov.uk"
          sh "git config --global user.name tna-digital-archiving-jenkins"
          sh "git commit -m 'Update plugins'"
          sshagent(['github-jenkins']) {
            sh "git push -u origin plugin-updates-${versionTag}"
          }
          def notes = sh(script: "cat pr-notes", returnStdout: true).trim()
          withCredentials([string(credentialsId: 'github-jenkins-api-key', variable: 'GITHUB_ACCESS_TOKEN')]) {
            sh "curl -XPOST 'https://api.github.com/repos/nationalarchives/tdr-jenkins/pulls' -H 'Authorization: bearer ${env.GITHUB_ACCESS_TOKEN}' --data '{\"title\":\"Jenkins plugin updates\",\"base\":\"master\",\"head\":\"${branch}\",\"body\":\"${notes}\"}'"
          }
        }
      }
    }
  }
}
